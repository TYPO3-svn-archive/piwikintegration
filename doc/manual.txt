EXT:piwikintegration
Extension Key: piwikintegration
Language: en
Keywords: piwik integration statistics
Copyright 2000-2010, Kay Strobach, <typo3@kay-strobach.de>

This document is published under the Open Content License
available from http://www.opencontent.org/opl.shtml

The content of this document is related to TYPO3 
- a GNU/GPL CMS/Framework available from www.typo3.org

Table of Contents
EXT:piwikintegration	1
What does it do	3
Important notes for Piwik 0.9 and current Piwikintegration	3
Screenshots	3
Administrative functions in backendmodule	4
Scheduler integration	5
Supported languages for BE module	5
Installation	6
Automated Installation (recommend)	6
Manual installation (draft may not be complete, not recommend)	6
3 ways to add the trackingcode	6
Filesystemstructure of the plugin	7
Modifying Piwik settings	7
Adding Piwik plugins	7
Use in TYPO3 frontend	8
Prerequisites	8
Add Content Element	8
Example for integration into a TYPO3 website.	9
Upgrade	10
From 0.x to 1.x	10
From 1.x to 2.0	10
From 2.0.x to 2.2.x	10
Settings in Extension manager	11
How does the integration work?	12
Statistics on your Desktop	13
Piwik API Code / token_auth / API Key	13
Piwik API URL	13
Applications	13
FAQ	14
Appendix	15
Changelog	15
Roadmap	15
Todo	15
Known Problems	15

What does it do
This extension implements Piwik tracking in TYPO3-based websites.
Piwik is a new open source (GPL license) web analytics product. It gives interesting reports on your website visitors, your popular pages, the search engines keywords they used, the language they speak… and so much more. To learn more about Piwik, go to http://www.piwik.org.
This extension is an addon to the extension of EXT:piwik which provides a Backendmodule and integration functionality to TYPO3
Support can only be provided via the newsgroup piwik on the TYPO3 newsserver.
Please post Bugs on forge.typo3.org in the project piwikintegration.
Important notes for Piwik 0.9 and current Piwikintegration
From this release there heavy changes under the hood.
That means, that the scheduler won't work. And it's not tested!
You can't change the Database where Piwik stores the data.
Screenshots
Piwik in Backend
Module without the skin extension

Module with Piwik skin extension TYPO3Menu (default in automatic installation)


EXT:templavoila with preview


Piwik wiget in TYPO3 frontend

Administrative functions in backendmodule
The Backendmodule is devided into 3 parts:
Overview: I would call it dashboard, it's simply a page which shows the most important statistics: Visitors, Frequency, Pages and Keywords.
Direct Statistics Access: Takes you to the original Piwik control panel, where you can find all statitics gathered by Piwik and also access the Admin section. This part can be skinned with the Piwik plugin TYPO3Menu (found in Admin page on Plugin tab).
Data for API use: Here you find your API Code (key) and your local Piwik URL along with the , JavaScriptTrackingCode display for use in external tools.
Administrative functions(not included yet): Here you can download GeoIPDatabase Download and Refresh the Piwik API Key

Scheduler integration
In TYPO3 4.3 there is a new extension called Scheduler (found in Admin tools / Scheduler). With that extension installed you can [what does the Piwik Archive Cron Job do and why should I use it?]. Use it like this:

1. Create a new task by clicking on the New icon
2. Setup an intervall like daily (=86400 seconds)
If you select the Piwik task and hit Execute selected tasks, you do not need to wait to see the statistics.
Have a look on http://piwik.org/docs/setup-auto-archiving/ to get more information on speeding up piwik. (ignore the cronjob, as this is executed by the Scheduler).
Please have a look on these options in the Piwik configuration, with the following setting you force piwik to create the statistics with the cronjob and not while opening Piwik in the browser, that will speedup using piwik.
[General]
time_before_today_archive_considered_outdated = 3600
enable_browser_archiving_triggering = false
Supported languages for BE module
Currently the Piwik integration BE module supports the following languages. You can translate this extension yourself via normal TYPO3 translation system (II-XML translation). Please provide your translations to the EXT:piwikintegration developer team.
English as default
German
To get the full list of available languages for the original Piwik application, please look into the official piwik blog at  http://piwik.org/translations/.
Installation
Automated Installation (recommend)
To integrate piwikintegration into your TYPO3 installation follow these steps:
1. Install the extension via TER, piwik is not included!
2. Also install and enable the EXT:piwik which is suggested, to get the trackingcode automatically.
You do not need to configure EXT:piwik since it is already configured with the static template of EXT:piwikintegration (see below).
Have a look in http://typo3.org/extensions/repository/view/piwik/current/ for setting up advanced options of EXT:piwik. You do not need to do this here.
3. Enable the extension EXT:piwikintegration.
4. Add the static template of EXT:piwikintegration (choose Web -> Template -> [page where you have your template] -> Info/Modify -> Edit whole template record -> Includes) This will enable a single idsite and add the needed ts-configuration for EXT:piwik, as described above.
5. Open the statistik module (Web -> Statistics ) and click on the page, or a subpage, where you added the static template:
1. The backendmodule now recognizes, that Piwik is not installed (by checking, if the config file exists).
2. The backendmodule will now download, extract and install the latest Piwik release into typo3conf/piwik. This could take a while.
3. The backendmodule will now reload and you will now able to use Piwik via the Direct Statistics Access dropdown box.
6. (If you like to use GeoIPDatabase use the admin functions of the module and download the database from maxmind.)[This function is currently not available.]
That's all you need to start tracking your visitors. See EXT:piwik manual for more config options and description of it's parameters.
Manual installation (draft may not be complete, not recommend)
To integrate piwikintegration into your TYPO3 installation follow these steps:
1. Install the extension via TER, piwik is not included!
2. Install and enable the EXT:piwik which is suggested, to get the Trackingcode automatically.
You do not need to configure EXT:piwik it's configured with the static template of EXT:piwikintegration (see below).
Have a look in http://typo3.org/extensions/repository/view/piwik/current/ for setting up advanced options of EXT:piwik. You do not need to do this here.
You do not need to install EXT:piwik, if you integrate the trackingcode on your own. But you need to setup up the siteid like described in http://typo3.org/extensions/repository/view/piwik/current/ in the EXT:piwik manual. This is needed, because EXT:piwikintegration uses the same setup as EXT:piwik
3. Install and enable the plugin EXT:piwikintegration.
4. Copy Piwik in typo3conf/piwik/piwik so that the index.php is accessable via typo3conf/piwik/piwik/index.php
5. Setup Piwik with the same database parameters as you use for your TYPO3 installation. You need to set the prefix to “tx_piwikintegration_“ as this is required for EXT:piwikintegration.
6. Open the statistik module, click on the page, or a subpage, where you have added the static template. The backendmodule should now recognize that Piwik is correctly installed (by checking if the config file exists). This will show the overview page.
7. Don't forget to install the TYPO3* plugins in Piwik application (Web -> Statistics -> Direct Statistics Access -> Admin -> Plugins), especially the TYPO3Auth plugin is mandatory for authentification against the TYPO3 session. If this works you can disable the Login plugin.
8. If you like to use GeoIPDatabase use the admin functions of the module and download the database from maxmind.
That's all you need to start tracking your visitors. See EXT:piwik manual for more config options and description of it's parameters.
3 ways to add the trackingcode
Basically there 3 ways to install the trackingcode to your site
The recommend way: EXT:piwik
Ext:piwik adds the trackingcode to your Page. All you need to do is to download and install EXT:piwik via the TYPO3 extension manager. Add the static TS of EXT:piwik and EXT:piwikintegration to your page template and configure the idsite. See http://typo3.org/extensions/repository/view/piwik/current/ for more details.
This way offers an easy configuration interface via EXT:piwik TS interface:
.piwik_idsite
.piwik_host
.piwik_action_name
.piwik_download_extensions
.piwik_hosts_alias
.piwik_tracker_pause
.piwik_install_tracker
Note: there is already a version 2.x in the SVN on forge.typo3.org which is still waiting to get published:
http://forge.typo3.org/repositories/show/extension-piwik
The manual way
Use EXT:piwikintegration to obtain the JS Code. Add it to your TS pagetemplate. Configure config.tx_piwik.piwik_idsite, because Ext:piwikintegration needs that value for setting up the users.
The debug way
EXT:piwikintegration is shipped with a basic trackingcode add script. You may enable it in the extension manager. And add the static TS of EXT:piwikintegration to your TS template. See the chapter “Settings in Extensionmanager” for more details. It's not recommend to use that option, as there is only one configuration option: config.tx_piwik.piwik_idsite.
Filesystemstructure of the plugin
Ext:piwikintegration installs like a normal plugin. It needs to be installed as local extension. Additionally Ext:piwikintegration creates a folder typo3conf/piwik where piwik will reside.
Modifying Piwik settings
Read the correspondng articles on piwik.org. You will find the configuration and all the needed files below typo3conf/piwik/piwik.
Adding Piwik plugins
Adding pluging to Piwik is as easy as extracting zip files to the plugins folder in the folder typo3conf/piwik/piwik.
I suggest to install EXT:t3extplorer and use the upload vie URL functionality of this extensions as here it is also possible to extract the files directly on the server.
Usefull plugins for Piwik:
AnonymizeIP for shortening Ip's
included
TYPO3Menu
included
GeoIP
http://dev.piwik.org/trac/ticket/45
Heatmap (still under heavy development)
http://dev.piwik.org/trac/ticket/73
The developer plattform allows you to search plugins with the following url.
http://dev.piwik.org/trac/query?status=new&status=assigned&status=reopened&milestone=Third+Party+Piwik+Plugins&order=priority
Use in TYPO3 frontend
Prerequisites
Before you can add a Piwik widget to your TYPO3 Frontend you need to allow anonymous access to the site you want to publish.
Add Content Element
General
To add a Piwik widget simply add it like every content element in TYPO3.
Options

The first one is the site id of piwik.
The second one lets you select the widget you want to display.
The third one set up the period. 
The fourth one lets you select how you want to display the data.
And last but not least you can set up the height of the div for the Piwik widget in your frontend.
The width is determined automatically by the browser of the user.
You can obtain these settings from your Piwik dashboard. On the Piwik dashboard you also have the chance to generate the code to integration Piwik widgets into other websites.
templavoila
In the templavoila backend module you will see a preview of the generated content element.

Example for integration into a TYPO3 website.

Upgrade
From 0.x to 1.x
No upgrade path
From 1.x to 2.0
Simply upgrade via TER, update the TS Setup with the new Option, after opening the BE Module piwik gets installed and you're done.
Don't forget to install EXT:piwik for automated adding of the trackingcode. ? Please check your page for the trackingcode as non logged in BE user, as EXT:piwik from version 2.x won't log authenticated BE Users.
From 2.0.x to 2.2.x
There is a new Piwik Plugin called TYPO3Menu which is shipped with version 2.1.0.
This plugin switches the gui of piwik into a more TYPO3 like style. You need to activate it manually, as EXT:piwikintegration tries to not touch your config if not really needed. The shipped Extensions have the same Version as EXT:piwikintegration by architecture. That makes it easy for you to find the correct plugins.
Settings in Extension manager
From the Extension manager you can choose to enable a few features:
EXPERIMENTAL independent mode [enableIndependentMode] 
EXT:piwikintegration contains a basic tracking JS; please don't enable this mode in EM if you have installed EXT:piwik, it will result in doubled Trackingcode in the Frontend.
EXPERIMENTAL scheduler task [enableSchedulerTask]
This option installs a Scheduler task that speeds up rendering of Piwik, as the statistics are build before viewing them in the browser. See related chapter of this document to get more information how to use this feature
Debugging of scheduler task [enableSchedulerLoging]  
As described in the extension manager this flag enables detailed logging for the piwik cronjob in the sys_log table.
Enable heavy logging for the piwik cronjob, should be off in production environments as this can result in very large tables. Please use this function for debugging only.

How does the integration work?
1. User opens statistik module for a specific page ? TYPO3 checks access ? Module inserts access records to piwik tables automatically (admin as superuser, normal user with view rights)
2. load piwik in iframe / object tag
3. Authenticate user against TYPO3 be_users table with the user of the be cookie. For that step the plugin TYPO3Login is needed in piwik.
4. That's all.
Statistics on your Desktop
In this chapter you will learn how to setup the Piwik API and how to get all the needed configuration variables. With that API you can use Piwik on your Desktop or in other Webapplications. In the last subsection of this chapter you will find someusefull tools for your desktop.
Piwik API Code / token_auth / API Key
Is supported, currently you need to set up the API key manually. You do that in the be_users form.
1. Admin tools -> User Admin
2. select the Admin user
3. Extended
4. Just click in the litte recycle icon to get a new API Code generated.

Currently there is also the way to set a key via the backend module statistics, but this is deprecated.
1. 
2. Select Page
3. 
4. 
Piwik API URL
Please take a look into the Statistics BE module to get the URL for Piwik API. Normally it should be:
DOMAIN/typo3conf/piwik/piwik/
Applications
There are 2 Adobe Air Applications, which enable you to see the statistics on your desk, without login into piwik.
Desktop Web Analytics - For Piwik
http://www.desktop-web-analytics.com/
Piwik Connector
http://www.piwik-connector.com/en/
FAQ
What do I have to do if the installation fails with:
There is no valid unzip wrapper, i need either the class ZipArchiv from php or a *nix system with unset path set.
You have 3 opinions:
1. Manual setup ? hard
2. Install Zip Extension for PHP
3. Do not use Microsoft Windows and disable $GLOBALS['TYPO3_CONF_VARS']['BE']['disable_exec_function'] in the TYPO3 Install tool.
Use with ks_sitemgr (currently not published in TER)
Use the customer id constant to setup the trackingcode – example will be provided later.
What to do if Piwik can't update?
There are 2 possible solutions
1. Manually unpack the archive into typo3conf/piwik
2. Make a list of installed plugins and settings, delete the typo3conf/piwik directory, make a clean install and reconfigure Piwik
Appendix
Changelog
See http://forge.typo3.org/projects/activity/extension-piwikintegration for the current Activity and Changelog
Roadmap
See http://forge.typo3.org/projects/roadmap/extension-piwikintegration for the current Roadmap
Todo
See http://forge.typo3.org/projects/extension-piwikintegration/issues for more details.
Known Problems
FIXED There is a know incompatibility with t3editor in TYPO3 4.2, it works in TYPO3 4.3RC1.
See http://forge.typo3.org/projects/extension-piwikintegration/issues for more details.
